# ìœ„í‚¤ë°±ê³¼ í…Œì´ë¸”ì—ì„œ ì™•ë¹„ì™€ í›„ê¶ì˜ ì„±ì”¨ì™€ ë³¸ê´€ì„ ì¶”ì¶œí•˜ëŠ” ë°©ë²• 
### ìœ„í‚¤ë°±ê³¼ í…Œì´ë¸” ì •ì œ(ì„±ì”¨+ë³¸ê´€ ì¶”ì¶œ ver)

## ìœ„í‚¤ë°±ê³¼ í…Œì´ë¸”ì´ êµ¬ì¡°í™” ë˜ì–´ìˆì§€ ì•Šì•˜ì„ ê²½ìš° 

#### ì˜ˆë¥¼ ë“¤ì–´ ë‹¤ë¥¸ êµ­ì™•ë“¤ì€ 

![Image](/assets/images/4.png)

#### ì´ë ‡ê²Œ ì§ê¸‰ê³¼ ì´ë¦„ì´ êµ¬ë¶„ë˜ì–´ ìˆëŠ” ë°˜ë©´ì— (<ì‹œí˜¸> ì—´ì— ì´ë¦„ë§Œ ë“¤ì–´ê°€ ìˆìŒ)

#### ì„±ì¢…ì€ 

![Image](/assets/images/5.png)

#### <ì‹œí˜¸>ë¼ëŠ” ì—´ì— ì •ë¹„|ê³µí˜œì™•í›„ í•œì”¨ê°€ ë“¤ì–´ê°€ ìˆì–´ì„œ rì—ì„œ ì˜¤ë¥˜ê°€ ë‚œë‹¤. 

#### ì´ëŸ° ê²½ìš° ì•„ë˜ ì½”ë“œë¥¼ í†µí•´ ì—´ ì´ë¦„ ì¤‘ë³µì„ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•´ì£¼ë©´ ì˜¤ë¥˜ê°€ ì•ˆ ë‚œë‹¤. 

```{r}
# ì—´ ì´ë¦„ ì¤‘ë³µ ìë™ ì²˜ë¦¬
colnames(concubine_table) <- make.names(colnames(concubine_table), unique = TRUE)
```

## ìµœì¢… ì½”ë“œ

```{r}
# í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°
library(tidyverse)
library(rvest)
library(stringr)
library(purrr)

# ì €ì¥ í´ë” ì„¤ì •
output_dir <- "C:/capstone/joseon_tables_final_413"
dir.create(output_dir, showWarnings = FALSE)

# ì¡°ì„  êµ­ì™• ë¦¬ìŠ¤íŠ¸
kings <- c("íƒœì¡°_(ì¡°ì„ )", "ì •ì¢…_(ì¡°ì„ )", "íƒœì¢…_(ì¡°ì„ )", "ì„¸ì¢…", "ë¬¸ì¢…_(ì¡°ì„ )", "ë‹¨ì¢…_(ì¡°ì„ )", "ì„¸ì¡°_(ì¡°ì„ )", "ì˜ˆì¢…_(ì¡°ì„ )", "ì„±ì¢…_(ì¡°ì„ )")

# ìì‹ í…Œì´ë¸” í•„í„° í‚¤ì›Œë“œ (ì™•ì ì „ìš©)
child_keywords <- c("ì‘í˜¸", "ì¥ë‚¨", "ì™•ì", "ëŒ€êµ°", "êµ°")

# í•¨ìˆ˜: URLì—ì„œ wikitableë§Œ ì¶”ì¶œ
tables_from_url <- function(url) {
  tryCatch({
    page <- read_html(url)
    page %>% html_nodes("table.wikitable")
  }, error = function(e) NULL)
}

# í•¨ìˆ˜: ì™•ë¹„ í…Œì´ë¸” ì¶”ì¶œ
find_queen_table <- function(parsed_tables) {
  parsed_tables %>% 
    keep(~ {
      has_title_col <- any(str_detect(names(.x), "ì‹œí˜¸"))
      first_two_cols <- .x[ , 1:min(2, ncol(.x))]
      has_queen <- any(str_detect(unlist(first_two_cols), "ì™•ë¹„|ì •ë¹„|ì™•í›„"))
      has_title_col & has_queen
    }) %>% 
    first()
}

# í•¨ìˆ˜: í›„ê¶ í…Œì´ë¸” ì¶”ì¶œ
find_concubine_table <- function(parsed_tables) {
  parsed_tables %>% 
    keep(~ {
      target_cols <- .x[ , 1:min(2, ncol(.x))]
      values <- str_detect(unlist(target_cols), "ë¹ˆ|ê¶ì£¼|ê·€ì¸|ì†Œìƒ|í›„ê¶|ìˆ™ì˜")
      any(replace_na(values, FALSE))
    }) %>% 
    first()
}

# ì „ì²´ ì„±ì”¨ + ë³¸ê´€ ë°ì´í„° ì €ì¥ìš©
all_queen_bongwan <- list()
all_concubine_bongwan <- list()

# ë©”ì¸ ë£¨í”„
for (king in kings) {
  cat("ì²˜ë¦¬ ì¤‘:", king, "\n")
  url <- paste0("https://ko.wikipedia.org/wiki/", king)
  tables <- tables_from_url(url)
  
  if (is.null(tables)) {
    cat(" - í˜ì´ì§€ ë¡œë”© ì‹¤íŒ¨\n")
    next
  }
  
  parsed_tables <- tables %>% map(~ html_table(.x, fill = TRUE))
  
  # ---------------- ì™•ë¹„ ì²˜ë¦¬ ----------------
  queen_table <- find_queen_table(parsed_tables)
  if (!is.null(queen_table)) {
    colnames(queen_table) <- make.names(colnames(queen_table), unique = TRUE)
    
    if ("ì‘í˜¸.1" %in% colnames(queen_table)) {
      surnames <- str_extract(queen_table$ì‘í˜¸.1, "[ê°€-í£]+ì”¨") %>% str_remove("ì”¨")
    } else {
      name_cols <- c("ì‹œí˜¸", "ì‹œí˜¸.1", "ì´ë¦„")
      name_data <- queen_table %>% select(any_of(name_cols)) %>% unite("full_name", everything(), sep = " ", na.rm = TRUE)
      surnames <- str_extract(name_data$full_name, "[ê°€-í£]{1,2}ì”¨")
      missing_idx <- which(is.na(surnames))
      if (length(missing_idx) > 0) {
        hanja_surnames <- str_extract(name_data$full_name[missing_idx], "[\u4E00-\u9FFF]{1,2}æ°")
        surnames[missing_idx] <- hanja_surnames
      }
    }
    
    bon_gwan <- if ("ë³¸ê´€" %in% names(queen_table)) queen_table$ë³¸ê´€ else rep("ë³¸ê´€í‘œì‹œx", nrow(queen_table))
    queen_bongwan <- tibble(ì„±ì”¨ = surnames, ë³¸ê´€ = bon_gwan)
    all_queen_bongwan[[king]] <- queen_bongwan
    cat("  âœ… ì™•ë¹„ ì„±ì”¨ + ë³¸ê´€ ì¶”ì¶œ ì„±ê³µ\n")
  } else {
    cat("  âš ï¸ ì™•ë¹„ í…Œì´ë¸” ì—†ìŒ\n")
  }
  
  # ---------------- í›„ê¶ ì²˜ë¦¬ ----------------
  concubine_table <- find_concubine_table(parsed_tables)
  if (!is.null(concubine_table)) {
    colnames(concubine_table) <- make.names(colnames(concubine_table), unique = TRUE)
    
    if ("ì‘í˜¸.1" %in% colnames(concubine_table)) {
      surnames <- str_extract(concubine_table$ì‘í˜¸.1, "[ê°€-í£]+ì”¨") %>% str_remove("ì”¨")
    } else {
      name_cols <- c("ì‹œí˜¸", "ì‹œí˜¸.1", "ì´ë¦„")
      name_data <- concubine_table %>% select(any_of(name_cols)) %>% unite("full_name", everything(), sep = " ", na.rm = TRUE)
      surnames <- str_extract(name_data$full_name, "[ê°€-í£]{1,2}ì”¨")
      missing_idx <- which(is.na(surnames))
      if (length(missing_idx) > 0) {
        hanja_surnames <- str_extract(name_data$full_name[missing_idx], "[\u4E00-\u9FFF]{1,2}æ°")
        surnames[missing_idx] <- hanja_surnames
      }
    }
    
    bon_gwan <- if ("ë³¸ê´€" %in% names(concubine_table)) concubine_table$ë³¸ê´€ else rep("ë³¸ê´€í‘œì‹œx", nrow(concubine_table))
    concubine_bongwan <- tibble(ì„±ì”¨ = surnames, ë³¸ê´€ = bon_gwan)
    all_concubine_bongwan[[king]] <- concubine_bongwan
    cat("  âœ… í›„ê¶ ì„±ì”¨ + ë³¸ê´€ ì¶”ì¶œ ì„±ê³µ\n")
  } else {
    cat("  âš ï¸ í›„ê¶ í…Œì´ë¸” ì—†ìŒ\n")
  }
}

# ê²°ê³¼ ì €ì¥
all_queen_bongwan_df <- bind_rows(all_queen_bongwan, .id = "ì™•")
all_concubine_bongwan_df <- bind_rows(all_concubine_bongwan, .id = "ì™•")

write_csv(all_queen_bongwan_df, file.path(output_dir, "all_queen_bongwan.csv"))
write_csv(all_concubine_bongwan_df, file.path(output_dir, "all_concubine_bongwan.csv"))

cat("ğŸ‰ ëª¨ë“  ì™•ì˜ ì„±ì”¨ + ë³¸ê´€ ì •ë³´ ì €ì¥ ì™„ë£Œ!\n")
```

